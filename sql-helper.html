<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SQL Helper</title>

    <link rel="stylesheet" href="./asset/css/bootstrap.min.css">
    <link rel="stylesheet" href="./asset/css/app.css">
</head>
<body>
<div class="container" id="container">
    <div id="sql" class="alert alert-success" style="height: 50px;"></div>
    <div class="row">
        <div class="col-md-2">
            <label for="type">语句类型</label>
            <select id="type" class="change form-control" v-model="checkedType">
                <option v-for="type in types" v-bind="{ value: type.value }">{{ type.name }}</option>
            </select>
        </div>

        <div class="col-md-2">
            <label for="table">数据表</label>
            <select id="table" class="change form-control" v-model="checkedTable">
                <option v-for="tb in TbFd" v-bind="{ value: tb.table }">{{ tb.table }}</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>字段</label>
            <div class="field-box" v-for="fds in TbFd | kaka">
                <div class="field-item" v-for="fd in fds.field">
                	<!-- // TODO checkbox -->
                	<!-- <div class="checkbox">
                	      <input type="checkbox">
                	</div> -->
                    <label><input v-bind="{ name: fd }" type="checkbox" class="condition hidden"> {{ fd }} = </label>
                    <input id="i-{{ fd }}" v-bind="{ name: fd }" type="text" class="field form-control" placeholder="条件" condition=false>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <button id="btn" class="btn btn-success btn-block">生成</button>
        </div>
    </div>

</div>

<script src="./asset/js/jquery-2.1.3.min.js"></script>
<script src="./asset/js/bootstrap.min.js"></script>
<script src="./asset/js/vue.min.js"></script>
<script src="./asset/js/app.js"></script>
<script>
    $(function () {
        var vmData = new Vue({
            el: "#container",

            data: {
                // table name 和 field name
                // 结构：[{table: "tableName", field: ["fd0", "fd1", ...]}, ...]
                TbFd: [],
                types: [
                    {name: "Insert", value: "INSERT"},
                    {name: "Delete", value: "DELETE"},
                    {name: "Update", value: "UPDATE"},
                    {name: "Query", value: "QUERY"}
                ],
                checkedType: "UPDATE",
                checkedTable: "tb_role",
                // 结构：[{name: "fieldName", value: "fieldValue"}, ...]
                checkedField: [],
                // 结构 checkedField ，用于保存选择的条件和条件值
                checkedCondition: []
            },

            methods: {
                // 通过检测input 的改变来动态修改语句。
                // 这个想法已经放弃，因为太难了⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄
//                fieldEdit: function (e) {
//                     方法内 `this` 指向 vm
//                     `event` 是原生 DOM 事件
//                    var fieldName = $(e.target).attr("name");
//                    var fieldValue = $(e.target).val();
//                    console.log(fieldName + ": " + fieldValue);
//                }
            }
        });

        // 自定义过滤器，返回指定表的所有字段
        // 过滤器参数未使用，因为我只需要触发它就可以了，真正需要的参数是checkedTable
        Vue.filter("kaka", function (table) {
//            return vmData.TbFd.filter(function (e) {
//                return e.table === vmData.checkedTable;
//            });
            return vmData.TbFd.filter((e) => {return (e.table === vmData.checkedTable)});
        });

        $.get("resolveDatabase.php", new Date().getTime(), function (result) {
//            console.log(result);
            vmData.TbFd = result.retData;
        });

        var sql = "";
        function updateSQL() {
            /******* 插入 *******/
            if (vmData.checkedType === vmData.types[0].value) {
                let filedNameStr = "",
                    filedValueStr = "";
                vmData.checkedField.forEach(function (e, i, a) {
                    filedNameStr += e.name + ", ";
                    filedValueStr += e.value + ", ";
                });

                filedNameStr = filedNameStr.slice(0, -2);
                filedValueStr = filedValueStr.slice(0, -2);
                sql = `INSERT INTO ${vmData.checkedTable} (` + filedNameStr + `) VALUES (` + filedValueStr + `)`;
                
            /******* 删除 *******/
            } else if (vmData.checkedType === vmData.types[1].value) {
                let str = "";
                vmData.checkedField.forEach(function (e, i, a) {
                    str += e.name + " = " + e.value + " AND ";
                });
                str = str.slice(0, -5);
                sql = `DELETE FROM ${vmData.checkedTable} WHERE ` + str; //TODO delete condition
                
            /******* 修改 *******/
            } else if (vmData.checkedType === vmData.types[2].value) {
                
                // 组成 SET 后面的语句
                let str = "";
                vmData.checkedField.forEach(function (e, i, a) {
                    str += `${e.name} = '${e.value}'` + ", ";
                });
                str = str.slice(0, -2);
                
                // 组成 WHERE 后面的语句
                let cond = "";
                vmData.checkedCondition.forEach(function (e, i, a) {
                    cond += `${e.name} = '${e.value}'` + " AND ";
                });
                cond = cond.slice(0, -5);
                
                sql = `UPDATE ${vmData.checkedTable} SET ` + str + " WHERE " + cond; //TODO update condition
                
            /******* 查询 *******/
            } else if (vmData.checkedType === vmData.types[3].value) {
                let str = "",
                    col = "*";
                vmData.checkedField.forEach(function (e, i, a) {
                    str += e.name + " = " + e.value + " AND ";
                });
                str = str.slice(0, -5);
                sql = `SELECT ` + col + ` FROM ${vmData.checkedTable} WHERE ` + str; //TODO select col and condition
            }

            $("#sql").html(`<code>${sql}</code>`);
        }

        // 标记有 class = change 的改变来动态修改SQL 语句
        // 主要就是几个 select 元素而已
        $("select.change").change(function () {
            // 切换语句类型前先将所有 checkbox 清空选择
            unCheckAll();
            if ($(this).val() === vmData.types[2].value) {
                $("input[type=checkbox]").removeClass("hidden");
            } else {
                $("input[type=checkbox]").addClass("hidden");
            }
            updateSQL();
        });

        // 通过最后手动点击来搜集填写的值
        $("#btn").click(function () {
            // 将 condition 标记清空
            $("input[type=text].field").each(function () {
                $(this).attr("condition", "false");
            });
            
            // 通过 checkbox 来检测和设置哪些字段是条件(通过设置 "condition" 属性为 "true")
            // 每次都读取页面上填写完毕的值，并在此之前清空原先的数组内容
            vmData.checkedCondition.length = 0;
            $("input[type=checkbox].condition:checked").each(function () {
                var fieldName = $(this).attr("name");
                var fieldID = `i-${fieldName}`;
                
                $(`#${fieldID}`).attr("condition", "true");
            });
            
            // 每次都读取页面上填写完毕的值，并在此之前清空原先的数组内容
            vmData.checkedField.length = 0;
            $("input[type=text].field").each(function () {
                var fieldName = $(this).attr("name");
                var fieldValue = $(this).val();
                var fieldID = `i-${fieldName}`;
                if (!isEmptyString(fieldValue)) {
                    // 如果设置了 "condition" 属性为 "true" 的话表示这个字段是条件(WHERE 后面的)
                    if ($(`#${fieldID}`).attr("condition") === "true") {
                        vmData.checkedCondition.push({name: fieldName, value: fieldValue});
                    } else {
                        vmData.checkedField.push({name: fieldName, value: fieldValue});
                    }
                }
            });
            
            // 更新语句
            updateSQL();
        });

    });
</script>
</body>
</html>